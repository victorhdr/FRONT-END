{% extends "base.html" %}
{% block title %}Nuevo producto - MiTienda{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/constructor.css') }}">
{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">

    <h1 class="h3 mb-4 text-center">Crear nuevo producto</h1>

    <p class="text-center text-muted mb-5">
      Puedes crear un producto <strong>est√°tico</strong> usando el formulario tradicional
      o un <strong>producto personalizado</strong> usando el constructor avanzado (Prototipo 2 ‚Äì ampliaci√≥n).
    </p>

    <!-- ============================================================
         LAYOUT PRINCIPAL
         - Columna izquierda: formulario cl√°sico
         - Columna central: constructor personalizado
         - Columna derecha: mini-carrito (reutiliza CartView)
    ============================================================ -->
    <div class="row g-5">

      <!-- ============================================================
           SECCI√ìN A) FORMULARIO TRADICIONAL (c√≥digo original)
      ============================================================ -->
      <div class="col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">

            <h2 class="h5 mb-3 text-center">Formulario cl√°sico</h2>
            <p class="small text-muted text-center">
              Este formulario pertenece a la funcionalidad original de la pr√°ctica.
            </p>

            <form method="post" class="mx-auto mt-3" style="max-width:440px;">
              
              <!-- Nombre -->
              <div class="mb-3">
                <label for="name" class="form-label">Nombre</label>
                <input type="text" id="name" name="name" class="form-control" required>
              </div>

              <!-- Precio -->
              <div class="mb-3">
                <label for="price" class="form-label">Precio (‚Ç¨)</label>
                <input type="number" id="price" name="price" step="0.01" min="0" class="form-control" required>
              </div>

              <!-- Imagen -->
              <div class="mb-3">
                <label for="image_path" class="form-label">Imagen</label>
                <select id="image_path" name="image_path" class="form-select">
                  <option value="products/p1.svg">products/p1.svg</option>
                  <option value="products/p2.svg">products/p2.svg</option>
                  <option value="products/p3.svg">products/p3.svg</option>
                  <option value="products/p4.svg">products/p4.svg</option>
                </select>
              </div>

              <div class="d-grid">
                <button class="btn btn-primary" type="submit">
                  Crear producto
                </button>
              </div>

            </form>

          </div>
        </div>
      </div>

      <!-- ============================================================
           SECCI√ìN B) CONSTRUCTOR PERSONALIZADO (PROTOTIPO 2)
           Arquitectura MVP + AJAX + JSON + vista previa din√°mica
      ============================================================ -->
      <div class="col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-body">

            <h2 class="h5 mb-3 text-center">Constructor de productos personalizados</h2>
            <p class="small text-muted text-center">
              Este m√≥dulo forma parte de la ampliaci√≥n avanzada de la pr√°ctica (Prototipo 2).
            </p>

            <div class="row g-4">

              <!-- ===========================
                   COLUMNA IZQ ‚Üí CONFIGURADOR
              ============================ -->
              <div class="col-12">

                <!-- Tipo -->
                <div class="mb-3">
                  <label for="cfg-product-type" class="form-label">Tipo de producto</label>
                  <select id="cfg-product-type" class="form-select">
                    <option value="camiseta">Camiseta</option>
                    <option value="taza">Taza</option>
                    <option value="mochila">Mochila</option>
                  </select>
                </div>

                <!-- Colores -->
                <div class="mb-3">
                  <span class="form-label d-block mb-1">Color principal</span>
                  <div class="d-flex flex-wrap gap-2" id="cfg-color-group">
                    <button class="btn btn-sm color-swatch active" data-color="white">Blanco</button>
                    <button class="btn btn-sm color-swatch" data-color="black">Negro</button>
                    <button class="btn btn-sm color-swatch" data-color="red">Rojo</button>
                    <button class="btn btn-sm color-swatch" data-color="blue">Azul</button>
                    <button class="btn btn-sm color-swatch" data-color="green">Verde</button>
                  </div>
                </div>

                <!-- Talla -->
                <div class="mb-3">
                  <label for="cfg-size" class="form-label">Talla</label>
                  <select id="cfg-size" class="form-select">
                    <option value="none">No aplica</option>
                    <option value="S">S</option>
                    <option value="M" selected>M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                  </select>
                </div>

                <!-- Extras -->
                <div class="mb-3">
                  <span class="form-label d-block mb-1">Extras</span>

                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="extra-logo">
                    <label class="form-check-label" for="extra-logo">Logo frontal (+3‚Ç¨)</label>
                  </div>

                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="extra-estampado">
                    <label class="form-check-label" for="extra-estampado">Estampado completo (+5‚Ç¨)</label>
                  </div>

                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="extra-edicion">
                    <label class="form-check-label" for="extra-edicion">Edici√≥n limitada (+7‚Ç¨)</label>
                  </div>
                </div>

                <!-- Cantidad -->
                <div class="mb-3">
                  <label for="cfg-quantity" class="form-label">Cantidad</label>
                  <input type="number" id="cfg-quantity" class="form-control" value="1" min="1" max="10">
                </div>

                <!-- Validaciones AJAX -->
                <div id="cfg-validation" class="alert alert-info small d-none"></div>

                <!-- Bot√≥n GENERAR JSON -->
                <div class="d-grid mt-3">
                  <button id="cfg-generate-json" class="btn btn-success">
                    Generar configuraci√≥n (JSON)
                  </button>
                </div>

                <!-- =====================================================
                     BOT√ìN ‚Üí A√ëADIR AL CARRITO
                     Lanza un evento "add-to-cart" que escucha CartController
                ====================================================== -->
                <div class="d-grid mt-2">
                  <button id="cfg-add-to-cart" class="btn btn-primary">
                    A√±adir al carrito
                  </button>
                </div>

              </div>

              <!-- ===========================
                   COLUMNA DCHA ‚Üí VISTA PREVIA
              ============================ -->
              <div class="col-12">

                <div id="cfg-preview" class="constructor-preview mb-4">
                  <div class="constructor-preview-box"></div>

                  <h3 id="cfg-preview-title" class="h6 mt-3">Camiseta b√°sica</h3>
                  <p id="cfg-preview-details" class="small text-muted">
                    Color blanco ¬∑ Talla M ¬∑ Sin extras
                  </p>

                  <p><strong>Precio estimado:</strong>
                    <span id="cfg-preview-price">0.00 ‚Ç¨</span>
                  </p>
                </div>

                <!-- JSON final -->
                <h3 class="h6 mt-3">Configuraci√≥n generada (JSON)</h3>
                <pre id="cfg-json-output" class="bg-light border rounded small p-3 overflow-auto">
Selecciona opciones y pulsa "Generar configuraci√≥n (JSON)".
                </pre>

              </div>

            </div> <!-- /row constructor -->

          </div>
        </div>
      </div>

      <!-- ============================================================
           SECCI√ìN C) MINI-CARRITO
           Reutiliza exactamente la misma estructura que en "Productos"
           y se actualiza mediante CartController + CartView
      ============================================================ -->
      <div class="col-lg-3">
        <aside class="card shadow-sm mini-cart">
          <div class="card-body d-flex flex-column">

            <h2 class="h6 mb-3">üõí Carrito</h2>

            <div id="cartEmptyMessage" class="text-muted small mb-2">
              Tu carrito est√° vac√≠o.
            </div>

            <!-- Lista din√°mica del carrito -->
            <ul id="cartItems" class="list-group mb-3 small"></ul>

            <div class="mt-auto">
              <div class="d-flex justify-content-between mb-2">
                <span><strong>Art√≠culos:</strong></span>
                <span id="cartTotalItems">0</span>
              </div>

              <div class="d-flex justify-content-between mb-3">
                <span><strong>Total:</strong></span>
                <span id="cartTotalPrice">0.00 ‚Ç¨</span>
              </div>

              <div class="d-grid gap-2">
                <button id="btnClearCart" class="btn btn-outline-danger btn-sm">
                  Vaciar carrito
                </button>
                <a href="{{ url_for('main.carrito') }}" class="btn btn-success btn-sm">
                  Ver carrito
                </a>
              </div>
            </div>

          </div>
        </aside>
      </div>

    </div> <!-- /row principal -->

  </div>
</section>
{% endblock %}

{% block extra_js %}
  <!-- JS del constructor -->
  <script type="module" src="{{ url_for('static', filename='js/constructorController.js') }}"></script>
{% endblock %}
